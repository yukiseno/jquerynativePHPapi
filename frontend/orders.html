<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Orders - ShopHub</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
      <div class="container">
        <a class="navbar-brand" href="index.html">
          <img
            src="images/logo.svg"
            alt="Logo"
            height="30"
            style="margin-right: 10px"
          />
          ShopHub
        </a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="index.html">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="cart.html">
                Cart
                <span class="cart-count" id="cartCount">0</span>
              </a>
            </li>
            <li class="nav-item" id="profileNav" style="display: none">
              <a class="nav-link" href="profile.html">Profile</a>
            </li>
            <li class="nav-item" id="loginNav">
              <a class="nav-link" href="login.html">Login</a>
            </li>
            <li class="nav-item" id="registerNav">
              <a class="nav-link" href="register.html">Register</a>
            </li>
            <li class="nav-item" id="logoutNav">
              <a class="nav-link" href="#" onclick="logout(); return false;"
                >Logout</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Orders Container -->
    <div class="container checkout-container">
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 30px;
        "
      >
        <h1>My Orders</h1>
        <a href="profile.html" class="btn btn-outline-secondary"
          >Back to Profile</a
        >
      </div>
      <div class="alert-container" id="alertContainer"></div>

      <!-- Orders Table -->
      <div style="overflow-x: auto">
        <table class="table table-hover">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Order ID</th>
              <th>Date</th>
              <th>Items</th>
              <th>Subtotal</th>
              <th>Discount</th>
              <th>Total</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="ordersTableBody">
            <tr>
              <td
                colspan="8"
                class="text-center text-muted"
                style="padding: 40px"
              >
                Loading orders...
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Order Details Modal-like View -->
      <div
        id="orderDetails"
        style="
          display: none;
          margin-top: 40px;
          border-top: 1px solid #ddd;
          padding-top: 40px;
        "
      >
        <h3 id="orderDetailsTitle" style="margin-bottom: 20px"></h3>
        <div class="row">
          <div class="col-md-8">
            <div style="overflow-x: auto">
              <table class="table">
                <thead class="table-light">
                  <tr>
                    <th>Product</th>
                    <th>Color</th>
                    <th>Size</th>
                    <th>Qty</th>
                    <th>Price</th>
                    <th>Subtotal</th>
                  </tr>
                </thead>
                <tbody id="orderItemsTable"></tbody>
              </table>
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-card">
              <div class="section-title">Order Summary</div>
              <div class="summary-item">
                <span>Subtotal:</span>
                <span id="detailsSubtotal">$0.00</span>
              </div>
              <div
                class="summary-item"
                id="detailsDiscountRow"
                style="display: none"
              >
                <span>Discount:</span>
                <span id="detailsDiscount" class="text-success">-$0.00</span>
              </div>
              <div class="summary-total">
                <span>Total:</span>
                <span id="detailsTotal">$0.00</span>
              </div>
              <button
                class="btn btn-outline-secondary w-100 mt-3"
                onclick="hideOrderDetails()"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      const API_URL = "http://localhost:3001/api";

      function updateAuthNav() {
        const token = localStorage.getItem("authToken");
        if (token) {
          $("#loginNav").hide();
          $("#registerNav").hide();
          $("#profileNav").show();
          $("#logoutNav").show();
        } else {
          $("#loginNav").show();
          $("#registerNav").show();
          $("#profileNav").hide();
          $("#logoutNav").hide();
        }
      }

      function logout() {
        localStorage.removeItem("authToken");
        localStorage.removeItem("authUser");
        updateAuthNav();
        updateCartCount();
        window.location.href = "index.html";
      }

      function updateCartCount() {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const count = cart.reduce((sum, item) => sum + item.quantity, 0);
        $("#cartCount").text(count);
      }

      function formatPrice(cents) {
        return "$" + (cents / 100).toFixed(2);
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
        });
      }

      function loadOrders() {
        const token = localStorage.getItem("authToken");

        if (!token) {
          window.location.href = "login.html";
          return;
        }

        $.ajax({
          url: API_URL + "/user/orders",
          type: "GET",
          contentType: "application/json",
          headers: {
            Authorization: "Bearer " + token,
          },
          success: function (response) {
            const orders = response.data || [];

            if (orders.length === 0) {
              $("#ordersTableBody").html(
                '<tr><td colspan="8" class="text-center text-muted" style="padding: 40px">No orders yet</td></tr>'
              );
              return;
            }

            let html = "";
            orders.forEach((order, index) => {
              html += `
                <tr style="cursor: pointer" onclick="showOrderDetails(${index})">
                  <td>${index + 1}</td>
                  <td>#${order.id}</td>
                  <td>${formatDate(order.created_at)}</td>
                  <td>
                    <span class="badge bg-info">View Items</span>
                  </td>
                  <td>${formatPrice(order.subtotal)}</td>
                  <td>${formatPrice(order.discount_total)}</td>
                  <td><strong>${formatPrice(order.total)}</strong></td>
                  <td>
                    <span class="badge bg-success">${order.status}</span>
                  </td>
                </tr>
              `;
            });

            $("#ordersTableBody").html(html);
            window.allOrders = orders;
          },
          error: function (xhr) {
            const error = xhr.responseJSON?.error || "Failed to load orders";
            $("#ordersTableBody").html(
              `<tr><td colspan="8" class="text-center text-danger">${error}</td></tr>`
            );
          },
        });
      }

      function showOrderDetails(orderIndex) {
        const order = window.allOrders[orderIndex];
        if (!order.items) {
          // Fetch order details with items
          const token = localStorage.getItem("authToken");
          $.ajax({
            url: API_URL + `/orders/${order.id}`,
            type: "GET",
            headers: {
              Authorization: "Bearer " + token,
            },
            success: function (response) {
              const orderData = response.data;
              displayOrderDetails(orderData);
            },
            error: function () {
              alert("Failed to load order details");
            },
          });
        } else {
          displayOrderDetails(order);
        }
      }

      function displayOrderDetails(order) {
        $("#orderDetailsTitle").text(
          `Order #${order.id} - ${formatDate(order.created_at)}`
        );

        // Display items
        let itemsHtml = "";
        if (order.items && order.items.length > 0) {
          order.items.forEach((item) => {
            itemsHtml += `
              <tr>
                <td>${item.product_name}</td>
                <td><span style="display: inline-block; width: 20px; height: 20px; background-color: #999; border-radius: 3px; vertical-align: middle;"></span></td>
                <td><span class="badge bg-secondary">${
                  item.size_name
                }</span></td>
                <td>${item.qty}</td>
                <td>${formatPrice(item.price)}</td>
                <td><strong>${formatPrice(item.subtotal)}</strong></td>
              </tr>
            `;
          });
        }
        $("#orderItemsTable").html(itemsHtml);

        // Display summary
        $("#detailsSubtotal").text(formatPrice(order.subtotal));
        $("#detailsTotal").text(formatPrice(order.total));

        if (order.discount_total > 0) {
          $("#detailsDiscountRow").show();
          $("#detailsDiscount").text(`-${formatPrice(order.discount_total)}`);
        } else {
          $("#detailsDiscountRow").hide();
        }

        // Show details section
        $("#orderDetails").show();
        // Scroll to details
        $("html, body").animate(
          { scrollTop: $("#orderDetails").offset().top - 100 },
          800
        );
      }

      function hideOrderDetails() {
        $("#orderDetails").hide();
      }

      // Initialize on page load
      $(document).ready(function () {
        updateAuthNav();
        updateCartCount();
        loadOrders();
      });
    </script>
  </body>
</html>
